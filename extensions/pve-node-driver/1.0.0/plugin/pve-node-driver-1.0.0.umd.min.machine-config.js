"use strict";(("undefined"!==typeof self?self:this)["webpackChunkpve_node_driver_1_0_0"]=("undefined"!==typeof self?self:this)["webpackChunkpve_node_driver_1_0_0"]||[]).push([[921],{505:function(e,t,l){l.r(t),l.d(t,{default:function(){return g}});var s=l(9274);const r={class:"mt-20 mb-20"},i={class:"mt-20"},a={class:"row mt-20"},o={class:"col span-6"},n={class:"col span-6"},c={class:"mt-20"},u={class:"row mt-20"},d={class:"col span-6"},h={class:"col span-6"};function p(e,t,l,p,m,v){const f=(0,s.resolveComponent)("LabeledInput"),k=(0,s.resolveComponent)("LabeledSelect"),V=(0,s.resolveComponent)("t");return(0,s.openBlock)(),(0,s.createElementBlock)("div",r,[null==m.resourcePools?((0,s.openBlock)(),(0,s.createBlock)(f,{key:0,type:"text",mode:l.mode,disabled:v.disabled,value:m.currentValue.resourcePool,onChange:t[0]||(t[0]=e=>{m.currentValue.resourcePool=e.target.value}),"label-key":"cluster.machineConfig.pve.resourcePool.label",required:""},null,8,["mode","disabled","value"])):((0,s.openBlock)(),(0,s.createBlock)(k,{key:1,mode:l.mode,disabled:v.disabled,value:m.currentValue.resourcePool,"onUpdate:value":t[1]||(t[1]=e=>m.currentValue.resourcePool=e),options:m.resourcePools,"label-key":"cluster.machineConfig.pve.resourcePool.label",required:""},null,8,["mode","disabled","value","options"])),null==m.templates?((0,s.openBlock)(),(0,s.createBlock)(f,{key:2,class:"mt-20",type:"number",mode:l.mode,disabled:v.disabled,value:m.currentValue.template,onChange:t[2]||(t[2]=e=>{m.currentValue.template=e.target.value}),"label-key":"cluster.machineConfig.pve.template.label",required:"",min:"1",step:"1"},null,8,["mode","disabled","value"])):((0,s.openBlock)(),(0,s.createBlock)(k,{key:3,class:"mt-20",mode:l.mode,disabled:v.disabled||null!=m.resourcePools&&!m.currentValue.resourcePool,value:v.templateSelectValue,"onUpdate:value":t[3]||(t[3]=e=>v.templateSelectValue=e),"onOption:selected":v.selectTemplate,options:Object.values(v.templateSelectOptions),"label-key":"cluster.machineConfig.pve.template.label",required:""},null,8,["mode","disabled","value","onOption:selected","options"])),(0,s.createElementVNode)("h2",i,[(0,s.createVNode)(V,{k:"cluster.machineConfig.pve.devices.header"})]),(0,s.createElementVNode)("div",a,[(0,s.createElementVNode)("div",o,[null==m.devices?((0,s.openBlock)(),(0,s.createBlock)(f,{key:0,type:"text",mode:l.mode,disabled:v.disabled,value:m.currentValue.isoDevice,onChange:t[4]||(t[4]=e=>{m.currentValue.isoDevice=e.target.value}),"label-key":"cluster.machineConfig.pve.devices.iso.label","tooltip-key":"cluster.machineConfig.pve.devices.iso.tooltip",required:""},null,8,["mode","disabled","value"])):((0,s.openBlock)(),(0,s.createBlock)(k,{key:1,mode:l.mode,disabled:v.disabled||null!=m.templates&&!m.currentValue.template,value:m.currentValue.isoDevice,"onUpdate:value":t[5]||(t[5]=e=>m.currentValue.isoDevice=e),options:v.isoDeviceSelectOptions,"label-key":"cluster.machineConfig.pve.devices.iso.label","tooltip-key":"cluster.machineConfig.pve.devices.iso.tooltip",required:""},null,8,["mode","disabled","value","options"]))]),(0,s.createElementVNode)("div",n,[null==m.devices?((0,s.openBlock)(),(0,s.createBlock)(f,{key:0,type:"text",mode:l.mode,value:m.currentValue.networkInterface,onChange:t[6]||(t[6]=e=>{m.currentValue.networkInterface=e.target.value}),"label-key":"cluster.machineConfig.pve.devices.network.label","tooltip-key":"cluster.machineConfig.pve.devices.network.tooltip",required:""},null,8,["mode","value"])):((0,s.openBlock)(),(0,s.createBlock)(k,{key:1,mode:l.mode,disabled:v.disabled||null!=m.templates&&!m.currentValue.template,value:m.currentValue.networkInterface,"onUpdate:value":t[7]||(t[7]=e=>m.currentValue.networkInterface=e),options:v.networkInterfaceSelectOptions,"label-key":"cluster.machineConfig.pve.devices.network.label","tooltip-key":"cluster.machineConfig.pve.devices.network.tooltip",required:""},null,8,["mode","disabled","value","options"]))])]),(0,s.createElementVNode)("h2",c,[(0,s.createVNode)(V,{k:"cluster.machineConfig.pve.ssh.header"})]),(0,s.createElementVNode)("div",u,[(0,s.createElementVNode)("div",d,[(0,s.createVNode)(f,{type:"text",mode:l.mode,value:m.currentValue.sshUser,"onUpdate:value":t[8]||(t[8]=e=>m.currentValue.sshUser=e),"label-key":"cluster.machineConfig.pve.ssh.username.label","tooltip-key":"cluster.machineConfig.pve.ssh.username.tooltip",required:""},null,8,["mode","value"])]),(0,s.createElementVNode)("div",h,[(0,s.createVNode)(f,{type:"number",mode:l.mode,value:m.currentValue.sshPort,"onUpdate:value":t[9]||(t[9]=e=>m.currentValue.sshPort=e),"label-key":"cluster.machineConfig.pve.ssh.port.label","tooltip-key":"cluster.machineConfig.pve.ssh.port.tooltip",required:"",min:"1",step:"1"},null,8,["mode","value"])])])])}var m=l(5664),v=l(4415),f=l(5533),k=l(4364),V={components:{LabeledInput:v.o,LabeledSelect:f.A},props:{mode:{type:String,required:!0},value:{type:Object,required:!0},credentialId:{type:String,required:!0}},data(){return{fetchingCount:0,credential:null,resourcePools:null,templates:null,devices:null,currentValue:{resourcePool:this.value.resourcePool??"",template:this.value.template?parseInt(this.value.template):0,isoDevice:this.value.isoDevice??"",networkInterface:this.value.networkInterface??"",sshUser:this.value.sshUser?this.value.sshUser:"service",sshPort:this.value.sshPort?parseInt(this.value.sshPort):22}}},created(){this.validate()},async fetch(){await this.fetchCredential(),await this.fetchResourcePools(),await this.fetchTemplates(),await this.fetchDevices()},watch:{async credentialId(){await this.$fetch(),this.validate()},"currentValue.resourcePool":async function(){await this.fetchTemplates(),await this.fetchDevices()},"currentValue.template":async function(){await this.fetchDevices()},currentValue:{deep:!0,handler(){this.validate()}},resourcePools(){null!=this.resourcePools&&(1==this.resourcePools.length&&(this.currentValue.resourcePool=this.resourcePools[0]),this.resourcePools.includes(this.currentValue.resourcePool)||(this.currentValue.resourcePool=""))},templates(){if(null==this.templates)return;1==this.templates.length&&(this.currentValue.template=this.templates[0].vmid);const e=this.templates.find((e=>this.currentValue.template==e.vmid));e||(this.currentValue.template=0)},isoDeviceSelectOptions(){null!=this.isoDeviceSelectOptions&&(1==this.isoDeviceSelectOptions.length&&(this.currentValue.isoDevice=this.isoDeviceSelectOptions[0]),this.isoDeviceSelectOptions.includes(this.currentValue.isoDevice)||(this.currentValue.isoDevice=""))},networkInterfaceSelectOptions(){null!=this.networkInterfaceSelectOptions&&(1==this.networkInterfaceSelectOptions.length&&(this.currentValue.networkInterface=this.networkInterfaceSelectOptions[0]),this.networkInterfaceSelectOptions.includes(this.currentValue.networkInterface)||(this.currentValue.networkInterface=""))}},methods:{validate(){""!=this.currentValue.resourcePool?this.currentValue.template<1?this.$emit("validationChanged",!1):""!=this.currentValue.isoDevice&&""!=this.currentValue.networkInterface&&""!=this.currentValue.sshUser?this.currentValue.sshPort<1?this.$emit("validationChanged",!1):(this.value.resourcePool=this.currentValue.resourcePool,this.value.template=this.currentValue.template.toString(),this.value.isoDevice=this.currentValue.isoDevice,this.value.networkInterface=this.currentValue.networkInterface,this.value.sshUser=this.currentValue.sshUser,this.value.sshPort=this.currentValue.sshPort.toString(),this.$emit("validationChanged",!0)):this.$emit("validationChanged",!1):this.$emit("validationChanged",!1)},async fetchCredential(){try{this.fetchingCount+=1;const e=await this.$store.dispatch("management/find",{type:m.bB,id:this.credentialId.replace(":","/")}),t={url:atob(e.data["pvecredentialConfig-url"]),insecureTls:"true"==atob(e.data["pvecredentialConfig-insecureTls"]),tokenId:atob(e.data["pvecredentialConfig-tokenId"]),tokenSecret:atob(e.data["pvecredentialConfig-tokenSecret"])};if(t.insecureTls)throw new Error("Insecure TLS is enabled");this.credential=t}catch(e){k.warn("Failed to fetch Proxmox VE credential, enhanced form fields are disabled",e),this.credential=null}finally{this.fetchingCount-=1}},async fetchResourcePools(){try{this.fetchingCount+=1;const{data:e}=await this.fetchFromProxmox("/api2/json/pools");this.resourcePools=e.map((e=>e.poolid))}catch(e){this.resourcePools=null}finally{this.fetchingCount-=1}},async fetchTemplates(){if(null!=this.credential)if(this.resourcePools&&""==this.currentValue.resourcePool)this.templates=[];else try{if(this.fetchingCount+=1,!this.currentValue.resourcePool)throw new Error("Resource pool is not selected");const{data:e}=await this.fetchFromProxmox(`/api2/json/pools?type=qemu&poolid=${this.currentValue.resourcePool}`);this.templates=e[0].members.filter((e=>1==e.template))}catch(e){this.templates=null}finally{this.fetchingCount-=1}else this.templates=null},async fetchDevices(){if(null!=this.credential)if(this.templates&&""==this.currentValue.template)this.devices=[];else try{if(this.fetchingCount+=1,!this.currentValue.template)throw new Error("Template is not selected");const e=this.templates.find((e=>this.currentValue.template==e.vmid));if(!e)throw new Error("Template not found");const{data:t}=await this.fetchFromProxmox(`/api2/json/nodes/${e.node}/qemu/${e.vmid}/pending`);this.devices=t}catch(e){this.devices=null}finally{this.fetchingCount-=1}else this.devices=null},fetchFromProxmox(e){if(null==this.credential)throw new Error("Credential not available");return this.$store.dispatch("management/request",{method:"GET",url:"/meta/proxy/"+this.credential.url.replace(/^https?:\/\//,"")+e,headers:{"X-API-Auth-Header":`PVEAPIToken=${this.credential.tokenId}=${this.credential.tokenSecret}`},redirectUnauthorized:!1})},selectTemplate(e){if(0!=Object.keys(this.templateSelectOptions).length){for(const[t,l]of Object.entries(this.templateSelectOptions))if(e==l)return void(this.currentValue.template=t);this.currentValue.template=0}else this.currentValue.template=0}},computed:{disabled(){return this.fetchingCount>0},templateSelectOptions(){return null===this.templates?{}:this.templates.reduce(((e,t)=>({...e,[t.vmid]:`${t.name} (${t.vmid})`})),{})},templateSelectValue(){return this.templateSelectOptions[this.currentValue.template]??""},isoDeviceSelectOptions(){return null==this.devices?null:this.devices.filter((e=>e.key)).filter((e=>e.value&&"string"==typeof e.value)).filter((e=>e.value.includes("media=cdrom"))).map((e=>e.key))},networkInterfaceSelectOptions(){return null==this.devices?null:this.devices.filter((e=>e.key)).filter((e=>e.key.startsWith("net"))).map((e=>e.key))}}},b=l(7433);const y=(0,b.A)(V,[["render",p]]);var g=y}}]);
//# sourceMappingURL=pve-node-driver-1.0.0.umd.min.machine-config.js.map